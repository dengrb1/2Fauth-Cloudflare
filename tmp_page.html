<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2FAuth Worker</title>
  <style>
    :root {
      --bg: #f3f7f6;
      --ink: #102a2c;
      --muted: #5c7173;
      --card: #ffffff;
      --line: #d8e4e1;
      --ok: #0f766e;
      --warn: #b42318;
      --chip: #e5f2ef;
      --shadow: 0 14px 36px rgba(16, 42, 44, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 20% 0%, #d9ede8 0, transparent 40%),
        linear-gradient(160deg, #f7faf9, #eef5f3 45%, #e8f2f0);
      min-height: 100vh;
    }
    .page { max-width: 1180px; margin: 28px auto; padding: 0 16px 32px; }
    .top {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      margin-bottom: 14px;
    }
    h1 { margin: 0; font-size: 24px; }
    .sub { color: var(--muted); font-size: 13px; }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 12px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; }
    .stack { display: grid; gap: 8px; }
    input, select, button, textarea {
      border-radius: 10px;
      border: 1px solid var(--line);
      padding: 9px 11px;
      font-size: 14px;
      min-height: 38px;
    }
    textarea { min-height: 90px; resize: vertical; width: 100%; }
    input, select { background: #fff; color: var(--ink); }
    button { border: 0; cursor: pointer; background: var(--ok); color: #fff; }
    button.ghost { background: #eff5f3; color: var(--ink); border: 1px solid var(--line); }
    button.warn { background: var(--warn); }
    .muted { color: var(--muted); font-size: 12px; }
    .error { color: var(--warn); font-size: 12px; }
    video { width: 100%; border-radius: 10px; border: 1px solid var(--line); background: #dfe9e6; }
    .entry-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
    }
    .entry {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }
    .entry .title { font-weight: 600; margin-bottom: 4px; }
    .entry .meta { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .chip {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 9px; border-radius: 999px; background: var(--chip);
      font-size: 12px;
    }
    .code { font-size: 28px; letter-spacing: 2px; font-weight: 700; margin: 8px 0 3px; }
    .bar { height: 6px; background: #ecf2f0; border-radius: 99px; overflow: hidden; }
    .bar > i { display: block; height: 100%; background: var(--ok); width: 0%; transition: width .3s; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 7px 4px; text-align: left; font-size: 13px; }
    #bootstrap, #login, #app { display: none; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <div>
        <h1>2FAuth Worker</h1>
        <div id="state" class="sub">Loading...</div>
      </div>
      <div id="whoami" class="sub"></div>
    </div>

    <section id="bootstrap" class="panel stack">
      <h3 style="margin:0;">Initialize Admin</h3>
      <div class="row">
        <input id="bsUser" placeholder="admin username" />
        <input id="bsPass" type="password" placeholder="password (>=10)" />
        <button onclick="bootstrap()">Initialize</button>
      </div>
      <div id="bsMsg" class="muted"></div>
    </section>

    <section id="login" class="panel stack">
      <h3 style="margin:0;">Sign In</h3>
      <div class="row">
        <input id="loginUser" placeholder="username" />
        <input id="loginPass" type="password" placeholder="password" />
        <button onclick="login()">Login</button>
      </div>
      <div id="loginMsg" class="muted"></div>
    </section>

    <section id="app">
      <div class="panel row" style="justify-content:space-between;align-items:center;">
        <div class="row">
          <input id="search" placeholder="Search label / issuer..." oninput="renderEntries()" />
          <select id="groupFilter" onchange="renderEntries()"><option value="">All groups</option></select>
          <button class="ghost" onclick="refreshAll()">Refresh</button>
        </div>
        <div class="row">
          <button class="ghost" onclick="exportData()">Export</button>
          <button class="ghost" onclick="exportDataEncrypted()">Export Encrypted</button>
          <button class="ghost" onclick="toggleImport()">Import</button>
          <button class="warn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div id="importPanel" class="panel stack" style="display:none;">
        <h3 style="margin:0;">Import Backup JSON</h3>
        <textarea id="importText" placeholder='Paste JSON from /api/export'></textarea>
        <div class="row">
          <input id="importPassphrase" type="password" placeholder="passphrase (for encrypted backup)" />
          <button onclick="importData()">Run Import</button>
          <button class="ghost" onclick="importDataEncrypted()">Run Encrypted Import</button>
        </div>
        <div id="importMsg" class="muted"></div>
      </div>

      <div class="grid">
        <div class="stack">
          <div class="panel stack">
            <h3 style="margin:0;">New Entry</h3>
            <input id="eLabel" placeholder="label (GitHub)" />
            <input id="eIssuer" placeholder="issuer (optional)" />
            <input id="eSecret" placeholder="base32 secret" />
            <input id="eUri" placeholder="or otpauth://totp/... / otpauth://hotp/..." />
            <div class="row">
              <button class="ghost" onclick="startScan()">Scan QR Camera</button>
              <button class="ghost" onclick="stopScan()">Stop Scan</button>
              <input id="qrImageFile" type="file" accept="image/*" onchange="scanImageFile(event)" />
            </div>
            <video id="scanVideo" autoplay playsinline style="display:none;"></video>
            <div id="scanMsg" class="muted"></div>
            <div class="row">
              <select id="eOtpType"><option value="totp">TOTP</option><option value="hotp">HOTP</option></select>
              <select id="eAlgo"><option>SHA-1</option><option>SHA-256</option><option>SHA-512</option></select>
              <input id="eDigits" value="6" style="width:74px;" />
              <input id="ePeriod" value="30" style="width:74px;" />
              <input id="eCounter" value="0" style="width:86px;" />
            </div>
            <select id="eGroup"><option value="">No group</option></select>
            <button onclick="createEntry()">Save Entry</button>
            <div id="entryMsg" class="muted"></div>
          </div>

          <div class="panel stack">
            <h3 style="margin:0;">Groups</h3>
            <div class="row">
              <input id="gName" placeholder="group name" />
              <input id="gColor" value="#0f766e" style="width:110px;" />
              <button onclick="createGroup()">Add</button>
            </div>
            <div id="groupsList" class="stack"></div>
          </div>

          <div id="adminPanel" class="panel stack" style="display:none;">
            <h3 style="margin:0;">Users (admin)</h3>
            <div class="row">
              <input id="uName" placeholder="username" />
              <input id="uPass" type="password" placeholder="password >=10" />
              <select id="uRole"><option value="user">user</option><option value="admin">admin</option></select>
              <button onclick="createUser()">Create</button>
            </div>
            <div id="userMsg" class="muted"></div>
            <table id="usersTable"></table>
          </div>
        </div>

        <div class="panel stack">
          <h3 style="margin:0;">My Authenticators</h3>
          <div id="entries" class="entry-grid"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    let currentUser = null;
    let entries = [];
    let groups = [];
    let codeState = {};
    let scanStream = null;
    let scanTimer = null;

    async function api(path, opts = {}) {
      const res = await fetch(path, {
        ...opts,
        headers: { "content-type": "application/json", ...(opts.headers || {}) },
        credentials: "include"
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail ? data.error + ": " + data.detail : (data.error || ("HTTP " + res.status)));
      return data;
    }

    function msg(id, text, err) {
      const el = document.getElementById(id);
      el.textContent = text || "";
      el.className = err ? "error" : "muted";
    }

    async function init() {
      try {
        const status = await api("/api/status");
        if (!status.initialized) {
          document.getElementById("state").textContent = "System not initialized yet.";
          document.getElementById("bootstrap").style.display = "block";
          return;
        }
        const me = await api("/api/me").catch(() => null);
        if (!me) {
          document.getElementById("state").textContent = "Please login.";
          document.getElementById("login").style.display = "block";
          return;
        }
        currentUser = me.user;
        document.getElementById("state").textContent = "Ready";
        document.getElementById("whoami").textContent = me.user.username + " (" + me.user.role + ")";
        document.getElementById("app").style.display = "block";
        if (me.user.role === "admin") document.getElementById("adminPanel").style.display = "block";
        await refreshAll();
        if (me.user.role === "admin") await refreshUsers();
      } catch (e) {
        document.getElementById("state").textContent = e.message;
      }
    }

    async function bootstrap() {
      try {
        await api("/api/bootstrap", {
          method: "POST",
          body: JSON.stringify({ username: v("bsUser"), password: v("bsPass") })
        });
        location.reload();
      } catch (e) { msg("bsMsg", e.message, true); }
    }

    async function login() {
      try {
        await api("/api/login", {
          method: "POST",
          body: JSON.stringify({ username: v("loginUser"), password: v("loginPass") })
        });
        location.reload();
      } catch (e) { msg("loginMsg", e.message, true); }
    }

    async function logout() {
      await api("/api/logout", { method: "POST", body: "{}" });
      location.reload();
    }

    function v(id) { return document.getElementById(id).value; }

    async function refreshAll() {
      const [e, g] = await Promise.all([api("/api/entries"), api("/api/groups")]);
      entries = e.entries || [];
      groups = g.groups || [];
      hydrateGroupSelects();
      renderGroups();
      renderEntries();
      await refreshVisibleCodes();
    }

    function hydrateGroupSelects() {
      const opts = ['<option value="">No group</option>'];
      const filter = ['<option value="">All groups</option>'];
      groups.forEach(function(g) {
        opts.push('<option value="' + g.id + '">' + esc(g.name) + '</option>');
        filter.push('<option value="' + g.id + '">' + esc(g.name) + '</option>');
      });
      document.getElementById("eGroup").innerHTML = opts.join("");
      document.getElementById("groupFilter").innerHTML = filter.join("");
    }

    function renderGroups() {
      const box = document.getElementById("groupsList");
      if (!groups.length) { box.innerHTML = '<div class="muted">No groups yet.</div>'; return; }
      box.innerHTML = groups.map(function(g) {
        return '<div class="row" style="justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:7px;">'
          + '<span class="chip"><i style="display:inline-block;width:8px;height:8px;border-radius:999px;background:' + esc(g.color || "#0f766e") + ';"></i>' + esc(g.name) + '</span>'
          + '<button class="warn" onclick="deleteGroup(' + g.id + ')">Delete</button>'
          + '</div>';
      }).join("");
    }

    function renderEntries() {
      const q = v("search").trim().toLowerCase();
      const gf = v("groupFilter");
      const list = entries.filter(function(e) {
        const text = (e.label + " " + (e.issuer || "")).toLowerCase();
        if (q && !text.includes(q)) return false;
        if (gf && String(e.group_id || "") !== gf) return false;
        return true;
      });
      const out = document.getElementById("entries");
      if (!list.length) { out.innerHTML = '<div class="muted">No entries match current filters.</div>'; return; }
      out.innerHTML = list.map(function(e) {
        const state = codeState[e.id] || {};
        const code = state.code || "------";
        const ex = state.expiresIn || "";
        const progress = state.progress || 0;
        const group = e.group_name ? '<span class="chip"><i style="display:inline-block;width:8px;height:8px;border-radius:999px;background:' + esc(e.group_color || "#0f766e") + ';"></i>' + esc(e.group_name) + '</span>' : '';
        const otpTag = '<span class="chip">' + esc((e.otp_type || "totp").toUpperCase()) + '</span>';
        const counter = (e.otp_type === "hotp") ? ('<span class="chip">counter ' + Number(e.hotp_counter || 0) + '</span>') : '';
        return '<article class="entry">'
          + '<div class="title">' + esc(e.label) + '</div>'
          + '<div class="meta">' + esc(e.issuer || "No issuer") + '</div>'
          + '<div class="row">' + otpTag + group + counter + '</div>'
          + '<div class="code" id="c-' + e.id + '">' + esc(code) + '</div>'
          + '<div class="muted" id="x-' + e.id + '">' + (ex ? (ex + "s left") : (e.otp_type === "hotp" ? "Click Generate" : "")) + '</div>'
          + '<div class="bar"><i id="p-' + e.id + '" style="width:' + progress + '%;"></i></div>'
          + '<div class="row" style="margin-top:8px;">'
          + (e.otp_type === "hotp"
            ? '<button onclick="genHotp(' + e.id + ')">Generate HOTP</button>'
            : '<button class="ghost" onclick="refreshCode(' + e.id + ')">Refresh Code</button>')
          + '<button class="ghost" onclick="editEntry(' + e.id + ')">Edit</button>'
          + '<button class="warn" onclick="deleteEntry(' + e.id + ')">Delete</button>'
          + '</div></article>';
      }).join("");
    }

    async function refreshVisibleCodes() {
      const current = entries.filter(function(e) { return e.otp_type !== "hotp"; });
      await Promise.all(current.map(function(e) { return refreshCode(e.id, true); }));
    }

    async function refreshCode(id, silent) {
      try {
        const r = await api("/api/entries/" + id + "/code");
        const entry = entries.find(function(x){ return x.id === id; });
        const period = Math.max(1, Number((entry && entry.period) || 30));
        const progress = Math.max(0, Math.min(100, ((period - r.expiresIn) / period) * 100));
        codeState[id] = { code: r.code, expiresIn: r.expiresIn, progress: progress };
        const codeEl = document.getElementById("c-" + id);
        const exEl = document.getElementById("x-" + id);
        const pEl = document.getElementById("p-" + id);
        if (codeEl) codeEl.textContent = r.code;
        if (exEl) exEl.textContent = r.expiresIn + "s left";
        if (pEl) pEl.style.width = progress + "%";
      } catch (e) {
        if (!silent) alert(e.message);
      }
    }

    async function genHotp(id) {
      try {
        const r = await api("/api/entries/" + id + "/hotp", { method: "POST", body: "{}" });
        codeState[id] = { code: r.code, expiresIn: 0, progress: 100 };
        await refreshAll();
      } catch (e) { alert(e.message); }
    }

    async function createEntry() {
      try {
        await api("/api/entries", {
          method: "POST",
          body: JSON.stringify({
            label: v("eLabel"),
            issuer: v("eIssuer"),
            secret: v("eSecret"),
            otpauthUri: v("eUri"),
            otpType: v("eOtpType"),
            algorithm: v("eAlgo"),
            digits: Number(v("eDigits") || 6),
            period: Number(v("ePeriod") || 30),
            hotpCounter: Number(v("eCounter") || 0),
            groupId: v("eGroup") ? Number(v("eGroup")) : null
          })
        });
        msg("entryMsg", "Saved");
        ["eLabel","eIssuer","eSecret","eUri"].forEach(function(id){ document.getElementById(id).value = ""; });
        await refreshAll();
      } catch (e) { msg("entryMsg", e.message, true); }
    }

    async function editEntry(id) {
      const e = entries.find(function(x){ return x.id === id; });
      if (!e) return;
      const label = prompt("Label", e.label); if (label === null) return;
      const issuer = prompt("Issuer", e.issuer || ""); if (issuer === null) return;
      const groupIdRaw = prompt("Group ID (empty for none)", e.group_id || "");
      const groupId = groupIdRaw ? Number(groupIdRaw) : null;
      await api("/api/entries/" + id, {
        method: "PATCH",
        body: JSON.stringify({ label: label, issuer: issuer, groupId: groupId })
      });
      await refreshAll();
    }

    async function deleteEntry(id) {
      if (!confirm("Delete this entry?")) return;
      await api("/api/entries/" + id, { method: "DELETE" });
      await refreshAll();
    }

    async function createGroup() {
      try {
        await api("/api/groups", {
          method: "POST",
          body: JSON.stringify({ name: v("gName"), color: v("gColor") })
        });
        document.getElementById("gName").value = "";
        await refreshAll();
      } catch (e) { alert(e.message); }
    }

    async function deleteGroup(id) {
      if (!confirm("Delete group? Entries will be ungrouped.")) return;
      await api("/api/groups/" + id, { method: "DELETE" });
      await refreshAll();
    }

    async function createUser() {
      try {
        await api("/api/users", {
          method: "POST",
          body: JSON.stringify({ username: v("uName"), password: v("uPass"), role: v("uRole") })
        });
        msg("userMsg", "User created");
        await refreshUsers();
      } catch (e) { msg("userMsg", e.message, true); }
    }

    async function refreshUsers() {
      const d = await api("/api/users");
      const table = document.getElementById("usersTable");
      table.innerHTML = "<tr><th>ID</th><th>Username</th><th>Role</th><th>Action</th></tr>";
      (d.users || []).forEach(function(u) {
        const next = u.role === "admin" ? "user" : "admin";
        table.innerHTML += "<tr><td>" + u.id + "</td><td>" + esc(u.username) + "</td><td>" + u.role + "</td><td><button class='ghost' onclick='switchRole(" + u.id + ","" + next + "")'>Set " + next + "</button> <button class='warn' onclick='deleteUser(" + u.id + ")'>Delete</button></td></tr>";
      });
    }

    async function switchRole(id, role) {
      await api("/api/users/" + id + "/role", { method: "PATCH", body: JSON.stringify({ role: role }) });
      await refreshUsers();
    }

    async function deleteUser(id) {
      if (!confirm("Delete user?")) return;
      await api("/api/users/" + id, { method: "DELETE" });
      await refreshUsers();
    }

    function toggleImport() {
      const el = document.getElementById("importPanel");
      el.style.display = el.style.display === "none" ? "block" : "none";
    }

    async function exportData() {
      const d = await api("/api/export");
      const text = JSON.stringify(d, null, 2);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        alert("Backup JSON copied to clipboard.");
      } else {
        prompt("Copy export JSON:", text);
      }
    }

    async function exportDataEncrypted() {
      const passphrase = prompt("Set backup passphrase (>=10 chars):");
      if (!passphrase) return;
      const d = await api("/api/export/encrypted", {
        method: "POST",
        body: JSON.stringify({ passphrase: passphrase })
      });
      const text = JSON.stringify(d.encrypted, null, 2);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        alert("Encrypted backup JSON copied to clipboard.");
      } else {
        prompt("Copy encrypted export JSON:", text);
      }
    }

    async function importData() {
      try {
        const payload = JSON.parse(v("importText") || "{}");
        const d = await api("/api/import", { method: "POST", body: JSON.stringify(payload) });
        msg("importMsg", "Imported groups=" + d.imported.groups + ", entries=" + d.imported.entries);
        await refreshAll();
      } catch (e) { msg("importMsg", e.message, true); }
    }

    async function importDataEncrypted() {
      try {
        const encrypted = JSON.parse(v("importText") || "{}");
        const passphrase = v("importPassphrase");
        const d = await api("/api/import/encrypted", {
          method: "POST",
          body: JSON.stringify({ encrypted: encrypted, passphrase: passphrase })
        });
        msg("importMsg", "Encrypted import done: groups=" + d.imported.groups + ", entries=" + d.imported.entries);
        await refreshAll();
      } catch (e) { msg("importMsg", e.message, true); }
    }

    async function startScan() {
      if (!("BarcodeDetector" in window)) {
        msg("scanMsg", "BarcodeDetector is not supported by this browser.", true);
        return;
      }
      try {
        const video = document.getElementById("scanVideo");
        scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = scanStream;
        video.style.display = "block";
        msg("scanMsg", "Camera scanning started...");
        const detector = new BarcodeDetector({ formats: ["qr_code"] });
        clearInterval(scanTimer);
        scanTimer = setInterval(async function() {
          try {
            const barcodes = await detector.detect(video);
            if (barcodes && barcodes.length) {
              const raw = String(barcodes[0].rawValue || "");
              if (raw) {
                document.getElementById("eUri").value = raw;
                msg("scanMsg", "QR detected. URI filled in form.");
                stopScan();
              }
            }
          } catch {}
        }, 600);
      } catch (e) {
        msg("scanMsg", "Camera access denied or unavailable: " + e.message, true);
      }
    }

    function stopScan() {
      if (scanTimer) { clearInterval(scanTimer); scanTimer = null; }
      if (scanStream) {
        scanStream.getTracks().forEach(function(t) { t.stop(); });
        scanStream = null;
      }
      const video = document.getElementById("scanVideo");
      if (video) {
        video.srcObject = null;
        video.style.display = "none";
      }
    }

    async function scanImageFile(ev) {
      if (!("BarcodeDetector" in window)) {
        msg("scanMsg", "BarcodeDetector is not supported by this browser.", true);
        return;
      }
      try {
        const file = ev && ev.target && ev.target.files && ev.target.files[0];
        if (!file) return;
        const bmp = await createImageBitmap(file);
        const detector = new BarcodeDetector({ formats: ["qr_code"] });
        const barcodes = await detector.detect(bmp);
        if (!barcodes.length) {
          msg("scanMsg", "No QR code found in image.", true);
          return;
        }
        const raw = String(barcodes[0].rawValue || "");
        document.getElementById("eUri").value = raw;
        msg("scanMsg", "QR detected from image.");
      } catch (e) {
        msg("scanMsg", "Failed to scan image: " + e.message, true);
      }
    }

    function esc(s) {
      return String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    setInterval(function() {
      entries.forEach(function(e) {
        if (e.otp_type !== "hotp") refreshCode(e.id, true);
      });
    }, 5000);

    init();
  </script>
</body>
</html>
